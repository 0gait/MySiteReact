{"ast":null,"code":"import _classCallCheck from \"C:\\\\Users\\\\tiriq\\\\Documents\\\\Tiago\\\\MyThings\\\\MyProjects\\\\site\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/classCallCheck\";\nimport _createClass from \"C:\\\\Users\\\\tiriq\\\\Documents\\\\Tiago\\\\MyThings\\\\MyProjects\\\\site\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/createClass\";\n/**\r\n * DevExtreme (esm/ui/scheduler/appointmentPopup/popup.js)\r\n * Version: 22.2.4\r\n * Build date: Thu Jan 19 2023\r\n *\r\n * Copyright (c) 2012 - 2023 Developer Express Inc. ALL RIGHTS RESERVED\r\n * Read about DevExtreme licensing here: https://js.devexpress.com/Licensing/\r\n */\nimport _extends from \"@babel/runtime/helpers/esm/extends\";\nimport devices from \"../../../core/devices\";\nimport $ from \"../../../core/renderer\";\nimport dateUtils from \"../../../core/utils/date\";\nimport { Deferred, when } from \"../../../core/utils/deferred\";\nimport { triggerResizeEvent } from \"../../../events/visibility_change\";\nimport Popup from \"../../popup/ui.popup\";\nimport { hide as hideLoading, show as showLoading } from \"../loading\";\nimport { createAppointmentAdapter } from \"../appointmentAdapter\";\nimport { getNormalizedResources } from \"../resources/utils\";\nimport { isPopupFullScreenNeeded, getMaxWidth, getPopupToolbarItems } from \"../../../renovation/ui/scheduler/appointment_edit_form/popup_config\";\nvar toMs = dateUtils.dateToMilliseconds;\nvar APPOINTMENT_POPUP_CLASS = \"dx-scheduler-appointment-popup\";\nvar DAY_IN_MS = toMs(\"day\");\nvar POPUP_CONFIG = {\n  height: \"auto\",\n  maxHeight: \"100%\",\n  showCloseButton: false,\n  showTitle: false,\n  defaultOptionsRules: [{\n    device: function device() {\n      return devices.current().android;\n    },\n    options: {\n      showTitle: false\n    }\n  }]\n};\nexport var ACTION_TO_APPOINTMENT = {\n  CREATE: 0,\n  UPDATE: 1,\n  EXCLUDE_FROM_SERIES: 2\n};\nexport var AppointmentPopup = /*#__PURE__*/function () {\n  function AppointmentPopup(scheduler, form) {\n    _classCallCheck(this, AppointmentPopup);\n    this.scheduler = scheduler;\n    this.form = form;\n    this.popup = null;\n    this.state = {\n      action: null,\n      lastEditData: null,\n      saveChangesLocker: false,\n      appointment: {\n        data: null\n      }\n    };\n  }\n  _createClass(AppointmentPopup, [{\n    key: \"show\",\n    value: function show(appointment, config) {\n      var _this = this;\n      this.state.appointment.data = appointment;\n      this.state.action = config.action;\n      this.state.excludeInfo = config.excludeInfo;\n      if (!this.popup) {\n        var popupConfig = this._createPopupConfig();\n        this.popup = this._createPopup(popupConfig);\n      }\n      this.popup.option(\"toolbarItems\", getPopupToolbarItems(config.isToolbarVisible, function (e) {\n        return _this._doneButtonClickHandler(e);\n      }));\n      this.popup.show();\n    }\n  }, {\n    key: \"hide\",\n    value: function hide() {\n      this.popup.hide();\n    }\n  }, {\n    key: \"dispose\",\n    value: function dispose() {\n      var _this$popup;\n      null === (_this$popup = this.popup) || void 0 === _this$popup ? void 0 : _this$popup.$element().remove();\n    }\n  }, {\n    key: \"_createPopup\",\n    value: function _createPopup(options) {\n      var popupElement = $(\"<div>\").addClass(APPOINTMENT_POPUP_CLASS).appendTo(this.scheduler.getElement());\n      return this.scheduler.createComponent(popupElement, Popup, options);\n    }\n  }, {\n    key: \"_createPopupConfig\",\n    value: function _createPopupConfig() {\n      var _this2 = this;\n      return _extends({}, POPUP_CONFIG, {\n        onHiding: function onHiding() {\n          return _this2.scheduler.focus();\n        },\n        contentTemplate: function contentTemplate() {\n          return _this2._createPopupContent();\n        },\n        onShowing: function onShowing(e) {\n          return _this2._onShowing(e);\n        },\n        copyRootClassesToWrapper: true,\n        _ignoreCopyRootClassesToWrapperDeprecation: true\n      });\n    }\n  }, {\n    key: \"_onShowing\",\n    value: function _onShowing(e) {\n      var _this3 = this;\n      this._updateForm();\n      var arg = {\n        form: this.form.dxForm,\n        popup: this.popup,\n        appointmentData: this.state.appointment.data,\n        cancel: false\n      };\n      this.scheduler.getAppointmentFormOpening()(arg);\n      this.scheduler.processActionResult(arg, function (canceled) {\n        if (canceled) {\n          e.cancel = true;\n        } else {\n          _this3.updatePopupFullScreenMode();\n        }\n      });\n    }\n  }, {\n    key: \"_createPopupContent\",\n    value: function _createPopupContent() {\n      this._createForm();\n      return this.form.dxForm.$element();\n    }\n  }, {\n    key: \"_createFormData\",\n    value: function _createFormData(rawAppointment) {\n      var appointment = this._createAppointmentAdapter(rawAppointment);\n      var dataAccessors = this.scheduler.getDataAccessors();\n      var resources = this.scheduler.getResources();\n      var normalizedResources = getNormalizedResources(rawAppointment, dataAccessors, resources);\n      return _extends({}, rawAppointment, normalizedResources, {\n        repeat: !!appointment.recurrenceRule\n      });\n    }\n  }, {\n    key: \"_createForm\",\n    value: function _createForm() {\n      var rawAppointment = this.state.appointment.data;\n      var formData = this._createFormData(rawAppointment);\n      this.form.create(this.triggerResize.bind(this), this.changeSize.bind(this), formData);\n    }\n  }, {\n    key: \"_isReadOnly\",\n    value: function _isReadOnly(rawAppointment) {\n      var appointment = this._createAppointmentAdapter(rawAppointment);\n      if (rawAppointment && appointment.disabled) {\n        return true;\n      }\n      if (this.state.action === ACTION_TO_APPOINTMENT.CREATE) {\n        return false;\n      }\n      return !this.scheduler.getEditingConfig().allowUpdating;\n    }\n  }, {\n    key: \"_createAppointmentAdapter\",\n    value: function _createAppointmentAdapter(rawAppointment) {\n      return createAppointmentAdapter(rawAppointment, this.scheduler.getDataAccessors(), this.scheduler.getTimeZoneCalculator());\n    }\n  }, {\n    key: \"_updateForm\",\n    value: function _updateForm() {\n      var data = this.state.appointment.data;\n      var appointment = this._createAppointmentAdapter(this._createFormData(data));\n      if (appointment.startDate) {\n        appointment.startDate = appointment.calculateStartDate(\"toAppointment\");\n      }\n      if (appointment.endDate) {\n        appointment.endDate = appointment.calculateEndDate(\"toAppointment\");\n      }\n      var formData = appointment.source();\n      this.form.readOnly = this._isReadOnly(formData);\n      this.form.updateFormData(formData);\n    }\n  }, {\n    key: \"triggerResize\",\n    value: function triggerResize() {\n      if (this.popup) {\n        triggerResizeEvent(this.popup.$element());\n      }\n    }\n  }, {\n    key: \"changeSize\",\n    value: function changeSize(isRecurrence) {\n      if (this.popup) {\n        var isFullScreen = isPopupFullScreenNeeded();\n        var maxWidth = isFullScreen ? \"100%\" : getMaxWidth(isRecurrence);\n        this.popup.option(\"fullScreen\", isFullScreen);\n        this.popup.option(\"maxWidth\", maxWidth);\n      }\n    }\n  }, {\n    key: \"updatePopupFullScreenMode\",\n    value: function updatePopupFullScreenMode() {\n      if (this.form.dxForm) {\n        var formData = this.form.formData;\n        var isRecurrence = formData[this.scheduler.getDataAccessors().expr.recurrenceRuleExpr];\n        if (this.visible) {\n          this.changeSize(isRecurrence);\n        }\n      }\n    }\n  }, {\n    key: \"saveChangesAsync\",\n    value: function saveChangesAsync(isShowLoadPanel) {\n      var _this4 = this;\n      var deferred = new Deferred();\n      var validation = this.form.dxForm.validate();\n      isShowLoadPanel && this._showLoadPanel();\n      when(validation && validation.complete || validation).done(function (validation) {\n        if (validation && !validation.isValid) {\n          hideLoading();\n          deferred.resolve(false);\n          return;\n        }\n        var adapter = _this4._createAppointmentAdapter(_this4.form.formData);\n        var clonedAdapter = adapter.clone({\n          pathTimeZone: \"fromAppointment\"\n        });\n        _this4._addMissingDSTTime(adapter, clonedAdapter);\n        var appointment = clonedAdapter.source();\n        delete appointment.repeat;\n        switch (_this4.state.action) {\n          case ACTION_TO_APPOINTMENT.CREATE:\n            _this4.scheduler.addAppointment(appointment).done(deferred.resolve);\n            break;\n          case ACTION_TO_APPOINTMENT.UPDATE:\n            _this4.scheduler.updateAppointment(_this4.state.appointment.data, appointment).done(deferred.resolve);\n            break;\n          case ACTION_TO_APPOINTMENT.EXCLUDE_FROM_SERIES:\n            _this4.scheduler.updateAppointment(_this4.state.excludeInfo.sourceAppointment, _this4.state.excludeInfo.updatedAppointment);\n            _this4.scheduler.addAppointment(appointment).done(deferred.resolve);\n        }\n        deferred.done(function () {\n          hideLoading();\n          _this4.state.lastEditData = appointment;\n        });\n      });\n      return deferred.promise();\n    }\n  }, {\n    key: \"_doneButtonClickHandler\",\n    value: function _doneButtonClickHandler(e) {\n      e.cancel = true;\n      this.saveEditDataAsync();\n    }\n  }, {\n    key: \"saveEditDataAsync\",\n    value: function saveEditDataAsync() {\n      var _this5 = this;\n      var deferred = new Deferred();\n      if (this._tryLockSaveChanges()) {\n        when(this.saveChangesAsync(true)).done(function () {\n          if (_this5.state.lastEditData) {\n            var adapter = _this5._createAppointmentAdapter(_this5.state.lastEditData);\n            var startDate = adapter.startDate,\n              endDate = adapter.endDate,\n              allDay = adapter.allDay;\n            var startTime = startDate.getTime();\n            var endTime = endDate.getTime();\n            var inAllDayRow = allDay || endTime - startTime >= DAY_IN_MS;\n            var dataAccessors = _this5.scheduler.getDataAccessors();\n            var resourceList = _this5.scheduler.getResources();\n            var normalizedResources = getNormalizedResources(_this5.state.lastEditData, dataAccessors, resourceList);\n            _this5.scheduler.updateScrollPosition(startDate, normalizedResources, inAllDayRow);\n            _this5.state.lastEditData = null;\n          }\n          _this5._unlockSaveChanges();\n          deferred.resolve();\n        });\n      }\n      return deferred.promise();\n    }\n  }, {\n    key: \"_showLoadPanel\",\n    value: function _showLoadPanel() {\n      var container = this.popup.$overlayContent();\n      showLoading({\n        container: container,\n        position: {\n          of: container\n        },\n        copyRootClassesToWrapper: true,\n        _ignoreCopyRootClassesToWrapperDeprecation: true\n      });\n    }\n  }, {\n    key: \"_tryLockSaveChanges\",\n    value: function _tryLockSaveChanges() {\n      if (false === this.state.saveChangesLocker) {\n        this.state.saveChangesLocker = true;\n        return true;\n      }\n      return false;\n    }\n  }, {\n    key: \"_unlockSaveChanges\",\n    value: function _unlockSaveChanges() {\n      this.state.saveChangesLocker = false;\n    }\n  }, {\n    key: \"_addMissingDSTTime\",\n    value: function _addMissingDSTTime(formAppointmentAdapter, clonedAppointmentAdapter) {\n      var timeZoneCalculator = this.scheduler.getTimeZoneCalculator();\n      clonedAppointmentAdapter.startDate = this._addMissingDSTShiftToDate(timeZoneCalculator, formAppointmentAdapter.startDate, clonedAppointmentAdapter.startDate);\n      if (clonedAppointmentAdapter.endDate) {\n        clonedAppointmentAdapter.endDate = this._addMissingDSTShiftToDate(timeZoneCalculator, formAppointmentAdapter.endDate, clonedAppointmentAdapter.endDate);\n      }\n    }\n  }, {\n    key: \"_addMissingDSTShiftToDate\",\n    value: function _addMissingDSTShiftToDate(timeZoneCalculator, originFormDate, clonedDate) {\n      var _timeZoneCalculator$g, _timeZoneCalculator$g2;\n      var originTimezoneShift = null === (_timeZoneCalculator$g = timeZoneCalculator.getOffsets(originFormDate)) || void 0 === _timeZoneCalculator$g ? void 0 : _timeZoneCalculator$g.common;\n      var clonedTimezoneShift = null === (_timeZoneCalculator$g2 = timeZoneCalculator.getOffsets(clonedDate)) || void 0 === _timeZoneCalculator$g2 ? void 0 : _timeZoneCalculator$g2.common;\n      var shiftDifference = originTimezoneShift - clonedTimezoneShift;\n      return shiftDifference ? new Date(clonedDate.getTime() + shiftDifference * toMs(\"hour\")) : clonedDate;\n    }\n  }, {\n    key: \"visible\",\n    get: function get() {\n      return this.popup ? this.popup.option(\"visible\") : false;\n    }\n  }]);\n  return AppointmentPopup;\n}();","map":null,"metadata":{},"sourceType":"module"}