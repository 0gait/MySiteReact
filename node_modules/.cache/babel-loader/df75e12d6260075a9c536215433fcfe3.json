{"ast":null,"code":"/**\r\n * DevExtreme (esm/ui/selection/selection.js)\r\n * Version: 22.2.4\r\n * Build date: Thu Jan 19 2023\r\n *\r\n * Copyright (c) 2012 - 2023 Developer Express Inc. ALL RIGHTS RESERVED\r\n * Read about DevExtreme licensing here: https://js.devexpress.com/Licensing/\r\n */\nimport Class from \"../../core/class\";\nimport deferredStrategy from \"./selection.strategy.deferred\";\nimport standardStrategy from \"./selection.strategy.standard\";\nimport { extend } from \"../../core/utils/extend\";\nimport { noop } from \"../../core/utils/common\";\nimport { isDefined } from \"../../core/utils/type\";\nimport { Deferred, when } from \"../../core/utils/deferred\";\nexport default Class.inherit({\n  ctor: function ctor(options) {\n    this.options = extend(this._getDefaultOptions(), options, {\n      selectedItemKeys: options.selectedKeys || []\n    });\n    this._selectionStrategy = this.options.deferred ? new deferredStrategy(this.options) : new standardStrategy(this.options);\n    this._focusedItemIndex = -1;\n    if (!this.options.equalByReference) {\n      this._selectionStrategy.updateSelectedItemKeyHash(this.options.selectedItemKeys);\n    }\n  },\n  _getDefaultOptions: function _getDefaultOptions() {\n    return {\n      allowNullValue: false,\n      deferred: false,\n      equalByReference: false,\n      mode: \"multiple\",\n      selectedItems: [],\n      selectionFilter: [],\n      maxFilterLengthInRequest: 0,\n      onSelectionChanged: noop,\n      key: noop,\n      keyOf: function keyOf(item) {\n        return item;\n      },\n      load: function load() {\n        return new Deferred().resolve([]);\n      },\n      totalCount: function totalCount() {\n        return -1;\n      },\n      isSelectableItem: function isSelectableItem() {\n        return true;\n      },\n      isItemSelected: function isItemSelected() {\n        return false;\n      },\n      getItemData: function getItemData(item) {\n        return item;\n      },\n      dataFields: noop,\n      filter: noop\n    };\n  },\n  validate: function validate() {\n    this._selectionStrategy.validate();\n  },\n  getSelectedItemKeys: function getSelectedItemKeys() {\n    return this._selectionStrategy.getSelectedItemKeys();\n  },\n  getSelectedItems: function getSelectedItems() {\n    return this._selectionStrategy.getSelectedItems();\n  },\n  selectionFilter: function selectionFilter(value) {\n    if (void 0 === value) {\n      return this.options.selectionFilter;\n    }\n    var filterIsChanged = this.options.selectionFilter !== value && JSON.stringify(this.options.selectionFilter) !== JSON.stringify(value);\n    this.options.selectionFilter = value;\n    filterIsChanged && this.onSelectionChanged();\n  },\n  setSelection: function setSelection(keys, updatedKeys) {\n    return this.selectedItemKeys(keys, false, false, false, updatedKeys);\n  },\n  select: function select(keys) {\n    return this.selectedItemKeys(keys, true);\n  },\n  deselect: function deselect(keys) {\n    return this.selectedItemKeys(keys, true, true);\n  },\n  selectedItemKeys: function selectedItemKeys(keys, preserve, isDeselect, isSelectAll, updatedKeys) {\n    var _keys;\n    keys = null !== (_keys = keys) && void 0 !== _keys ? _keys : [];\n    keys = Array.isArray(keys) ? keys : [keys];\n    this.validate();\n    return this._selectionStrategy.selectedItemKeys(keys, preserve, isDeselect, isSelectAll, updatedKeys);\n  },\n  clearSelection: function clearSelection() {\n    return this.selectedItemKeys([]);\n  },\n  _addSelectedItem: function _addSelectedItem(itemData, key) {\n    this._selectionStrategy.addSelectedItem(key, itemData);\n  },\n  _removeSelectedItem: function _removeSelectedItem(key) {\n    this._selectionStrategy.removeSelectedItem(key);\n  },\n  _setSelectedItems: function _setSelectedItems(keys, items) {\n    this._selectionStrategy.setSelectedItems(keys, items);\n  },\n  onSelectionChanged: function onSelectionChanged() {\n    this._selectionStrategy.onSelectionChanged();\n  },\n  changeItemSelection: function changeItemSelection(itemIndex, keys, setFocusOnly) {\n    var _this = this;\n    var _this$options$allowLo, _this$options;\n    var isSelectedItemsChanged;\n    var items = this.options.plainItems();\n    var item = items[itemIndex];\n    var deferred;\n    var allowLoadByRange = null === (_this$options$allowLo = (_this$options = this.options).allowLoadByRange) || void 0 === _this$options$allowLo ? void 0 : _this$options$allowLo.call(_this$options);\n    var indexOffset;\n    var focusedItemNotInLoadedRange = false;\n    var shiftFocusedItemNotInLoadedRange = false;\n    var itemIsNotInLoadedRange = function itemIsNotInLoadedRange(index) {\n      return index >= 0 && !items.filter(function (it) {\n        return it.loadIndex === index;\n      }).length;\n    };\n    if (allowLoadByRange) {\n      indexOffset = item.loadIndex - itemIndex;\n      itemIndex = item.loadIndex;\n      focusedItemNotInLoadedRange = itemIsNotInLoadedRange(this._focusedItemIndex);\n      if (isDefined(this._shiftFocusedItemIndex)) {\n        shiftFocusedItemNotInLoadedRange = itemIsNotInLoadedRange(this._shiftFocusedItemIndex);\n      }\n    }\n    if (!this.isSelectable() || !this.isDataItem(item)) {\n      return false;\n    }\n    var itemData = this.options.getItemData(item);\n    var itemKey = this.options.keyOf(itemData);\n    keys = keys || {};\n    if (keys.shift && \"multiple\" === this.options.mode && this._focusedItemIndex >= 0) {\n      if (focusedItemNotInLoadedRange || shiftFocusedItemNotInLoadedRange) {\n        isSelectedItemsChanged = itemIndex !== this._shiftFocusedItemIndex || this._focusedItemIndex !== this._shiftFocusedItemIndex;\n        if (isSelectedItemsChanged) {\n          deferred = this.changeItemSelectionWhenShiftKeyInVirtualPaging(itemIndex);\n        }\n      } else {\n        isSelectedItemsChanged = this.changeItemSelectionWhenShiftKeyPressed(itemIndex, items, indexOffset);\n      }\n    } else if (keys.control) {\n      this._resetItemSelectionWhenShiftKeyPressed();\n      if (!setFocusOnly) {\n        var isSelected = this._selectionStrategy.isItemDataSelected(itemData);\n        if (\"single\" === this.options.mode) {\n          this.clearSelectedItems();\n        }\n        if (isSelected) {\n          this._removeSelectedItem(itemKey);\n        } else {\n          this._addSelectedItem(itemData, itemKey);\n        }\n      }\n      isSelectedItemsChanged = true;\n    } else {\n      this._resetItemSelectionWhenShiftKeyPressed();\n      var isKeysEqual = this._selectionStrategy.equalKeys(this.options.selectedItemKeys[0], itemKey);\n      if (1 !== this.options.selectedItemKeys.length || !isKeysEqual) {\n        this._setSelectedItems([itemKey], [itemData]);\n        isSelectedItemsChanged = true;\n      }\n    }\n    if (isSelectedItemsChanged) {\n      when(deferred).done(function () {\n        _this._focusedItemIndex = itemIndex;\n        !setFocusOnly && _this.onSelectionChanged();\n      });\n      return true;\n    }\n  },\n  isDataItem: function isDataItem(item) {\n    return this.options.isSelectableItem(item);\n  },\n  isSelectable: function isSelectable() {\n    return \"single\" === this.options.mode || \"multiple\" === this.options.mode;\n  },\n  isItemDataSelected: function isItemDataSelected(data) {\n    return this._selectionStrategy.isItemDataSelected(data, {\n      checkPending: true\n    });\n  },\n  isItemSelected: function isItemSelected(arg, options) {\n    return this._selectionStrategy.isItemKeySelected(arg, options);\n  },\n  _resetItemSelectionWhenShiftKeyPressed: function _resetItemSelectionWhenShiftKeyPressed() {\n    delete this._shiftFocusedItemIndex;\n  },\n  _resetFocusedItemIndex: function _resetFocusedItemIndex() {\n    this._focusedItemIndex = -1;\n  },\n  changeItemSelectionWhenShiftKeyInVirtualPaging: function changeItemSelectionWhenShiftKeyInVirtualPaging(loadIndex) {\n    var _this2 = this;\n    var loadOptions = this.options.getLoadOptions(loadIndex, this._focusedItemIndex, this._shiftFocusedItemIndex);\n    var deferred = new Deferred();\n    var indexOffset = loadOptions.skip;\n    this.options.load(loadOptions).done(function (items) {\n      _this2.changeItemSelectionWhenShiftKeyPressed(loadIndex, items, indexOffset);\n      deferred.resolve();\n    });\n    return deferred.promise();\n  },\n  changeItemSelectionWhenShiftKeyPressed: function changeItemSelectionWhenShiftKeyPressed(itemIndex, items, indexOffset) {\n    var isSelectedItemsChanged = false;\n    var itemIndexStep;\n    var indexOffsetDefined = isDefined(indexOffset);\n    var index = indexOffsetDefined ? this._focusedItemIndex - indexOffset : this._focusedItemIndex;\n    var keyOf = this.options.keyOf;\n    var focusedItem = items[index];\n    var focusedData = this.options.getItemData(focusedItem);\n    var focusedKey = keyOf(focusedData);\n    var isFocusedItemSelected = focusedItem && this.isItemDataSelected(focusedData);\n    if (!isDefined(this._shiftFocusedItemIndex)) {\n      this._shiftFocusedItemIndex = this._focusedItemIndex;\n    }\n    var data;\n    var itemKey;\n    var startIndex;\n    var endIndex;\n    if (this._shiftFocusedItemIndex !== this._focusedItemIndex) {\n      itemIndexStep = this._focusedItemIndex < this._shiftFocusedItemIndex ? 1 : -1;\n      startIndex = indexOffsetDefined ? this._focusedItemIndex - indexOffset : this._focusedItemIndex;\n      endIndex = indexOffsetDefined ? this._shiftFocusedItemIndex - indexOffset : this._shiftFocusedItemIndex;\n      for (index = startIndex; index !== endIndex; index += itemIndexStep) {\n        if (indexOffsetDefined || this.isDataItem(items[index])) {\n          itemKey = keyOf(this.options.getItemData(items[index]));\n          this._removeSelectedItem(itemKey);\n          isSelectedItemsChanged = true;\n        }\n      }\n    }\n    if (itemIndex !== this._shiftFocusedItemIndex) {\n      itemIndexStep = itemIndex < this._shiftFocusedItemIndex ? 1 : -1;\n      startIndex = indexOffsetDefined ? itemIndex - indexOffset : itemIndex;\n      endIndex = indexOffsetDefined ? this._shiftFocusedItemIndex - indexOffset : this._shiftFocusedItemIndex;\n      for (index = startIndex; index !== endIndex; index += itemIndexStep) {\n        if (indexOffsetDefined || this.isDataItem(items[index])) {\n          data = this.options.getItemData(items[index]);\n          itemKey = keyOf(data);\n          this._addSelectedItem(data, itemKey);\n          isSelectedItemsChanged = true;\n        }\n      }\n    }\n    if ((indexOffsetDefined || this.isDataItem(focusedItem)) && !isFocusedItemSelected) {\n      this._addSelectedItem(focusedData, focusedKey);\n      isSelectedItemsChanged = true;\n    }\n    return isSelectedItemsChanged;\n  },\n  clearSelectedItems: function clearSelectedItems() {\n    this._setSelectedItems([], []);\n  },\n  selectAll: function selectAll(isOnePage) {\n    this._resetFocusedItemIndex();\n    if (isOnePage) {\n      return this._onePageSelectAll(false);\n    } else {\n      return this.selectedItemKeys([], true, false, true);\n    }\n  },\n  deselectAll: function deselectAll(isOnePage) {\n    this._resetFocusedItemIndex();\n    if (isOnePage) {\n      return this._onePageSelectAll(true);\n    } else {\n      return this.selectedItemKeys([], true, true, true);\n    }\n  },\n  _onePageSelectAll: function _onePageSelectAll(isDeselect) {\n    var items = this._selectionStrategy.getSelectableItems(this.options.plainItems());\n    for (var i = 0; i < items.length; i++) {\n      var item = items[i];\n      if (this.isDataItem(item)) {\n        var itemData = this.options.getItemData(item);\n        var itemKey = this.options.keyOf(itemData);\n        var isSelected = this.isItemSelected(itemKey);\n        if (!isSelected && !isDeselect) {\n          this._addSelectedItem(itemData, itemKey);\n        }\n        if (isSelected && isDeselect) {\n          this._removeSelectedItem(itemKey);\n        }\n      }\n    }\n    this.onSelectionChanged();\n    return new Deferred().resolve();\n  },\n  getSelectAllState: function getSelectAllState(visibleOnly) {\n    return this._selectionStrategy.getSelectAllState(visibleOnly);\n  }\n});","map":null,"metadata":{},"sourceType":"module"}