{"ast":null,"code":"/**\r\n * DevExtreme (esm/ui/pivot_grid/ui.pivot_grid.field_chooser.js)\r\n * Version: 22.2.4\r\n * Build date: Thu Jan 19 2023\r\n *\r\n * Copyright (c) 2012 - 2023 Developer Express Inc. ALL RIGHTS RESERVED\r\n * Read about DevExtreme licensing here: https://js.devexpress.com/Licensing/\r\n */\nimport $ from \"../../core/renderer\";\nimport { getImageContainer } from \"../../core/utils/icon\";\nimport { hasWindow as hasWindowFn } from \"../../core/utils/window\";\nimport { isDefined } from \"../../core/utils/type\";\nimport { extend } from \"../../core/utils/extend\";\nimport { each } from \"../../core/utils/iterator\";\nimport localizationMessage from \"../../localization/message\";\nimport registerComponent from \"../../core/component_registrator\";\nimport { getCompareFunction, foreachDataLevel } from \"./ui.pivot_grid.utils\";\nimport TreeView from \"../tree_view\";\nimport ContextMenu from \"../context_menu\";\nimport BaseFieldChooser from \"./ui.pivot_grid.field_chooser_base\";\nvar DIV = \"<div>\";\nvar hasWindow = hasWindowFn();\nimport \"./data_source\";\nimport { SortableConst } from \"./sortable/index\";\nvar FIELDCHOOSER_CLASS = \"dx-pivotgridfieldchooser\";\nvar FIELDCHOOSER_CONTAINER_CLASS = \"dx-pivotgridfieldchooser-container\";\nvar FIELDS_CONTAINER_CLASS = \"dx-pivotgrid-fields-container\";\nvar AREA_DRAG_CLASS = \"dx-pivotgrid-drag-action\";\nfunction getDimensionFields(item, fields) {\n  var result = [];\n  if (item.items) {\n    for (var i = 0; i < item.items.length; i++) {\n      result.push.apply(result, getDimensionFields(item.items[i], fields));\n    }\n  } else if (isDefined(item.index)) {\n    result.push(fields[item.index]);\n  }\n  return result;\n}\nfunction getFirstItem(item, condition) {\n  if (item.items) {\n    for (var i = 0; i < item.items.length; i++) {\n      var childrenItem = getFirstItem(item.items[i], condition);\n      if (childrenItem) {\n        return childrenItem;\n      }\n    }\n  }\n  if (condition(item)) {\n    return item;\n  }\n}\nvar compareOrder = [function (a, b) {\n  var aValue = -!!a.isMeasure;\n  var bValue = +!!b.isMeasure;\n  return aValue + bValue;\n}, function (a, b) {\n  var aValue = -!!(a.items && a.items.length);\n  var bValue = +!!(b.items && b.items.length);\n  return aValue + bValue;\n}, function (a, b) {\n  var aValue = +!!(false === a.isMeasure && a.field && a.field.levels && a.field.levels.length);\n  var bValue = -!!(false === b.isMeasure && b.field && b.field.levels && b.field.levels.length);\n  return aValue + bValue;\n}, getCompareFunction(function (item) {\n  return item.text;\n})];\nfunction compareItems(a, b) {\n  var result = 0;\n  var i = 0;\n  while (!result && compareOrder[i]) {\n    result = compareOrder[i++](a, b);\n  }\n  return result;\n}\nfunction getScrollable(container) {\n  return container.find(\".dx-scrollable\").dxScrollable(\"instance\");\n}\nvar FieldChooser = BaseFieldChooser.inherit({\n  _getDefaultOptions: function _getDefaultOptions() {\n    return extend(this.callBase(), {\n      height: 400,\n      layout: 0,\n      dataSource: null,\n      encodeHtml: true,\n      onContextMenuPreparing: null,\n      allowSearch: false,\n      searchTimeout: 500,\n      texts: {\n        columnFields: localizationMessage.format(\"dxPivotGrid-columnFields\"),\n        rowFields: localizationMessage.format(\"dxPivotGrid-rowFields\"),\n        dataFields: localizationMessage.format(\"dxPivotGrid-dataFields\"),\n        filterFields: localizationMessage.format(\"dxPivotGrid-filterFields\"),\n        allFields: localizationMessage.format(\"dxPivotGrid-allFields\")\n      }\n    });\n  },\n  _refreshDataSource: function _refreshDataSource() {\n    var that = this;\n    that._expandedPaths = [];\n    that._changedHandler = that._changedHandler || function () {\n      each(that._dataChangedHandlers, function (_, func) {\n        func();\n      });\n      that._fireContentReadyAction();\n      that._skipStateChange = true;\n      that.option(\"state\", that._dataSource.state());\n      that._skipStateChange = false;\n    };\n    that._disposeDataSource();\n    that.callBase();\n    that._dataSource && that._dataSource.on(\"changed\", that._changedHandler);\n  },\n  _disposeDataSource: function _disposeDataSource() {\n    var dataSource = this._dataSource;\n    if (dataSource) {\n      dataSource.off(\"changed\", this._changedHandler);\n      this._dataSource = void 0;\n    }\n  },\n  _dispose: function _dispose() {\n    this._disposeDataSource();\n    this.callBase.apply(this, arguments);\n  },\n  _init: function _init() {\n    this.callBase();\n    this._refreshDataSource();\n    this._dataChangedHandlers = [];\n    this._initActions();\n  },\n  _initActions: function _initActions() {\n    this._actions = {\n      onContextMenuPreparing: this._createActionByOption(\"onContextMenuPreparing\")\n    };\n  },\n  _trigger: function _trigger(eventName, eventArg) {\n    this._actions[eventName](eventArg);\n  },\n  _setOptionsByReference: function _setOptionsByReference() {\n    this.callBase();\n    extend(this._optionsByReference, {\n      dataSource: true\n    });\n  },\n  _optionChanged: function _optionChanged(args) {\n    switch (args.name) {\n      case \"dataSource\":\n        this._refreshDataSource();\n        this._invalidate();\n        break;\n      case \"layout\":\n      case \"texts\":\n      case \"allowSearch\":\n      case \"searchTimeout\":\n      case \"encodeHtml\":\n        this._invalidate();\n        break;\n      case \"onContextMenuPreparing\":\n        this._actions[args.name] = this._createActionByOption(args.name);\n        break;\n      default:\n        this.callBase(args);\n    }\n  },\n  _clean: function _clean(skipStateSetting) {\n    !skipStateSetting && this._dataSource && this.option(\"state\", this._dataSource.state());\n    this.$element().children(\".\" + FIELDCHOOSER_CONTAINER_CLASS).remove();\n  },\n  _renderLayout0: function _renderLayout0($container) {\n    $container.addClass(\"dx-layout-0\");\n    var $row1 = $(DIV).addClass(\"dx-row\").appendTo($container);\n    var $row2 = $(DIV).addClass(\"dx-row\").appendTo($container);\n    var $col1 = $(DIV).addClass(\"dx-col\").appendTo($row1);\n    var $col2 = $(DIV).addClass(\"dx-col\").appendTo($row1);\n    var $col3 = $(DIV).addClass(\"dx-col\").appendTo($row2);\n    var $col4 = $(DIV).addClass(\"dx-col\").appendTo($row2);\n    this._renderArea($col1, \"all\");\n    this._renderArea($col2, \"row\");\n    this._renderArea($col2, \"column\");\n    this._renderArea($col3, \"filter\");\n    this._renderArea($col4, \"data\");\n  },\n  _renderLayout1: function _renderLayout1($container) {\n    var $col1 = $(DIV).addClass(\"dx-col\").appendTo($container);\n    var $col2 = $(DIV).addClass(\"dx-col\").appendTo($container);\n    this._renderArea($col1, \"all\");\n    this._renderArea($col2, \"filter\");\n    this._renderArea($col2, \"row\");\n    this._renderArea($col2, \"column\");\n    this._renderArea($col2, \"data\");\n  },\n  _renderLayout2: function _renderLayout2($container) {\n    $container.addClass(\"dx-layout-2\");\n    var $row1 = $(DIV).addClass(\"dx-row\").appendTo($container);\n    this._renderArea($row1, \"all\");\n    var $row2 = $(DIV).addClass(\"dx-row\").appendTo($container);\n    var $col1 = $(DIV).addClass(\"dx-col\").appendTo($row2);\n    var $col2 = $(DIV).addClass(\"dx-col\").appendTo($row2);\n    this._renderArea($col1, \"filter\");\n    this._renderArea($col1, \"row\");\n    this._renderArea($col2, \"column\");\n    this._renderArea($col2, \"data\");\n  },\n  _initMarkup: function _initMarkup() {\n    var $element = this.$element();\n    var $container = $(DIV).addClass(FIELDCHOOSER_CONTAINER_CLASS).appendTo($element);\n    var layout = this.option(\"layout\");\n    this.callBase();\n    $element.addClass(FIELDCHOOSER_CLASS).addClass(FIELDS_CONTAINER_CLASS);\n    this._dataChangedHandlers = [];\n    var dataSource = this._dataSource;\n    var currentState = \"instantly\" !== this.option(\"applyChangesMode\") && dataSource && dataSource.state();\n    currentState && this.option(\"state\") && dataSource.state(this.option(\"state\"), true);\n    if (0 === layout) {\n      this._renderLayout0($container);\n    } else if (1 === layout) {\n      this._renderLayout1($container);\n    } else {\n      this._renderLayout2($container);\n    }\n    currentState && dataSource.state(currentState, true);\n  },\n  _renderContentImpl: function _renderContentImpl() {\n    this.callBase();\n    this.renderSortable();\n    this._renderContextMenu();\n    this.updateDimensions();\n  },\n  _fireContentReadyAction: function _fireContentReadyAction() {\n    if (!this._dataSource || !this._dataSource.isLoading()) {\n      this.callBase();\n    }\n  },\n  _getContextMenuArgs: function _getContextMenuArgs(dxEvent) {\n    var targetFieldElement = $(dxEvent.target).closest(\".dx-area-field\");\n    var targetGroupElement = $(dxEvent.target).closest(\".dx-area-fields\");\n    var field;\n    var area;\n    if (targetFieldElement.length) {\n      var fieldCopy = targetFieldElement.data(\"field\");\n      if (fieldCopy) {\n        field = this.getDataSource().field(fieldCopy.index) || fieldCopy;\n      }\n    }\n    if (targetGroupElement.length) {\n      area = targetGroupElement.attr(\"group\");\n    }\n    return {\n      event: dxEvent,\n      field: field,\n      area: area,\n      items: []\n    };\n  },\n  _renderContextMenu: function _renderContextMenu() {\n    var that = this;\n    var $container = that.$element();\n    if (that._contextMenu) {\n      that._contextMenu.$element().remove();\n    }\n    that._contextMenu = that._createComponent($(DIV).appendTo($container), ContextMenu, {\n      onPositioning: function onPositioning(actionArgs) {\n        var event = actionArgs.event;\n        if (!event) {\n          return;\n        }\n        var args = that._getContextMenuArgs(event);\n        that._trigger(\"onContextMenuPreparing\", args);\n        if (args.items && args.items.length) {\n          actionArgs.component.option(\"items\", args.items);\n        } else {\n          actionArgs.cancel = true;\n        }\n      },\n      target: $container,\n      onItemClick: function onItemClick(params) {\n        params.itemData.onItemClick && params.itemData.onItemClick(params);\n      },\n      cssClass: \"dx-pivotgridfieldchooser-context-menu\"\n    });\n  },\n  _createTreeItems: function _createTreeItems(fields, groupFieldNames, path) {\n    var that = this;\n    var isMeasure;\n    var resultItems = [];\n    var groupedItems = [];\n    var groupFieldName = groupFieldNames[0];\n    var fieldsByGroup = {};\n    if (!groupFieldName) {\n      each(fields, function (index, field) {\n        var icon;\n        if (true === field.isMeasure) {\n          icon = \"measure\";\n        }\n        if (false === field.isMeasure) {\n          icon = field.groupName ? \"hierarchy\" : \"dimension\";\n        }\n        resultItems.push({\n          index: field.index,\n          field: field,\n          key: field.dataField,\n          selected: isDefined(field.area),\n          text: field.caption || field.dataField,\n          icon: icon,\n          isMeasure: field.isMeasure,\n          isDefault: field.isDefault\n        });\n      });\n    } else {\n      each(fields, function (index, field) {\n        var groupName = field[groupFieldName] || \"\";\n        fieldsByGroup[groupName] = fieldsByGroup[groupName] || [];\n        fieldsByGroup[groupName].push(field);\n        if (void 0 === isMeasure) {\n          isMeasure = true;\n        }\n        isMeasure = isMeasure && true === field.isMeasure;\n      });\n      each(fieldsByGroup, function (groupName, fields) {\n        var currentPath = path ? path + \".\" + groupName : groupName;\n        var items = that._createTreeItems(fields, groupFieldNames.slice(1), currentPath);\n        if (groupName) {\n          groupedItems.push({\n            key: groupName,\n            text: groupName,\n            path: currentPath,\n            isMeasure: items.isMeasure,\n            expanded: that._expandedPaths.includes(currentPath),\n            items: items\n          });\n        } else {\n          resultItems = items;\n        }\n      });\n      resultItems = groupedItems.concat(resultItems);\n      resultItems.isMeasure = isMeasure;\n    }\n    return resultItems;\n  },\n  _createFieldsDataSource: function _createFieldsDataSource(dataSource) {\n    var fields = dataSource && dataSource.fields() || [];\n    fields = fields.filter(function (field) {\n      return false !== field.visible && !isDefined(field.groupIndex);\n    });\n    var treeItems = this._createTreeItems(fields, [\"dimension\", \"displayFolder\"]);\n    foreachDataLevel(treeItems, function (items) {\n      items.sort(compareItems);\n    }, 0, \"items\");\n    return treeItems;\n  },\n  _renderFieldsTreeView: function _renderFieldsTreeView(container) {\n    var that = this;\n    var dataSource = that._dataSource;\n    var treeView = that._createComponent(container, TreeView, {\n      dataSource: that._createFieldsDataSource(dataSource),\n      showCheckBoxesMode: \"normal\",\n      expandNodesRecursive: false,\n      searchEnabled: that.option(\"allowSearch\"),\n      searchTimeout: that.option(\"searchTimeout\"),\n      useNativeScrolling: false,\n      itemTemplate: function itemTemplate(itemData, itemIndex, itemElement) {\n        var $item = $(\"<div>\").toggleClass(\"dx-area-field\", !itemData.items).attr(SortableConst.attrs.treeViewItem, true).data(\"field\", itemData.field).appendTo(itemElement);\n        if (itemData.icon) {\n          getImageContainer(itemData.icon).appendTo($item);\n        }\n        $(\"<span>\").text(itemData.text).appendTo($item);\n      },\n      onItemCollapsed: function onItemCollapsed(e) {\n        var index = that._expandedPaths.indexOf(e.itemData.path);\n        if (index >= 0) {\n          that._expandedPaths.splice(index, 1);\n        }\n      },\n      onItemExpanded: function onItemExpanded(e) {\n        var index = that._expandedPaths.indexOf(e.itemData.path);\n        if (index < 0) {\n          that._expandedPaths.push(e.itemData.path);\n        }\n      },\n      onItemSelectionChanged: function onItemSelectionChanged(e) {\n        var data = e.itemData;\n        var field;\n        var fields;\n        var needSelectDefaultItem = true;\n        var area;\n        if (data.items) {\n          if (data.selected) {\n            treeView.unselectItem(data);\n            return;\n          }\n          that._processDemandState(function () {\n            fields = getDimensionFields(data, dataSource.fields());\n            for (var i = 0; i < fields.length; i++) {\n              if (fields[i].area) {\n                needSelectDefaultItem = false;\n                break;\n              }\n            }\n          });\n          if (needSelectDefaultItem) {\n            var item = getFirstItem(data, function (item) {\n              return item.isDefault;\n            }) || getFirstItem(data, function (item) {\n              return isDefined(item.index);\n            });\n            item && treeView.selectItem(item);\n            return;\n          }\n        } else {\n          field = dataSource.fields()[data.index];\n          if (data.selected) {\n            area = field.isMeasure ? \"data\" : \"column\";\n          }\n          if (field) {\n            fields = [field];\n          }\n        }\n        that._applyChanges(fields, {\n          area: area,\n          areaIndex: void 0\n        });\n      }\n    });\n    that._dataChangedHandlers.push(function () {\n      var scrollable = getScrollable(container);\n      var scrollTop = scrollable ? scrollable.scrollTop() : 0;\n      treeView.option({\n        dataSource: that._createFieldsDataSource(dataSource)\n      });\n      scrollable = getScrollable(container);\n      if (scrollable) {\n        scrollable.scrollTo({\n          y: scrollTop\n        });\n        scrollable.update();\n      }\n    });\n  },\n  _renderAreaFields: function _renderAreaFields($container, area) {\n    var that = this;\n    var dataSource = that._dataSource;\n    var fields = dataSource ? extend(true, [], dataSource.getAreaFields(area, true)) : [];\n    $container.empty();\n    each(fields, function (_, field) {\n      if (false !== field.visible) {\n        that.renderField(field, true).appendTo($container);\n      }\n    });\n  },\n  _renderArea: function _renderArea(container, area) {\n    var that = this;\n    var $areaContainer = $(DIV).addClass(\"dx-area\").appendTo(container);\n    var $fieldsHeaderContainer = $(DIV).addClass(\"dx-area-fields-header\").appendTo($areaContainer);\n    var caption = that.option(\"texts.\" + area + \"Fields\");\n    var $fieldsContent;\n    var render;\n    $(\"<span>\").addClass(\"dx-area-icon\").addClass(\"dx-area-icon-\" + area).appendTo($fieldsHeaderContainer);\n    $(\"<span>\").html(\"&nbsp;\").appendTo($fieldsHeaderContainer);\n    $(\"<span>\").addClass(\"dx-area-caption\").text(caption).appendTo($fieldsHeaderContainer);\n    var $fieldsContainer = $(DIV).addClass(\"dx-area-fields\").addClass(AREA_DRAG_CLASS).appendTo($areaContainer);\n    if (\"all\" !== area) {\n      $fieldsContainer.attr(\"group\", area).attr(\"allow-scrolling\", true);\n      $fieldsContent = $(DIV).addClass(\"dx-area-field-container\").appendTo($fieldsContainer);\n      render = function render() {\n        that._renderAreaFields($fieldsContent, area);\n      };\n      that._dataChangedHandlers.push(render);\n      render();\n      $fieldsContainer.dxScrollable({\n        useNative: false\n      });\n    } else {\n      $areaContainer.addClass(\"dx-all-fields\");\n      $fieldsContainer.addClass(\"dx-treeview-border-visible\");\n      that._renderFieldsTreeView($fieldsContainer);\n    }\n  },\n  _getSortableOptions: function _getSortableOptions() {\n    return {};\n  },\n  _adjustSortableOnChangedArgs: function _adjustSortableOnChangedArgs() {},\n  resetTreeView: function resetTreeView() {\n    var treeView = this.$element().find(\".dx-treeview\").dxTreeView(\"instance\");\n    if (treeView) {\n      treeView.option(\"searchValue\", \"\");\n      treeView.collapseAll();\n    }\n  },\n  applyChanges: function applyChanges() {\n    var state = this.option(\"state\");\n    if (isDefined(state)) {\n      this._dataSource.state(state);\n    }\n  },\n  cancelChanges: function cancelChanges() {\n    var dataSource = this._dataSource;\n    if (!dataSource.isLoading()) {\n      this.option(\"state\", dataSource.state());\n      return true;\n    }\n    return false;\n  },\n  getDataSource: function getDataSource() {\n    return this._dataSource;\n  },\n  updateDimensions: function updateDimensions() {\n    var $scrollableElements = this.$element().find(\".dx-area .dx-scrollable\");\n    $scrollableElements.dxScrollable(\"update\");\n  },\n  _visibilityChanged: function _visibilityChanged(visible) {\n    if (visible && hasWindow) {\n      this.updateDimensions();\n    }\n  }\n});\nregisterComponent(\"dxPivotGridFieldChooser\", FieldChooser);\nexport default FieldChooser;","map":null,"metadata":{},"sourceType":"module"}